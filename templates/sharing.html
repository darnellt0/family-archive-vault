{% extends "base.html" %}

{% block title %}Sharing - Family Archive Vault{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">ðŸ”— Sharing & Access</h1>
        <p class="text-gray-600">Create secure links to share your archive with family members</p>
    </div>

    <!-- Create New Share -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Create New Share Link</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Share Name</label>
                <input type="text" id="share-name" placeholder="e.g., Grandma's Birthday Photos" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue">
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Expires In</label>
                <select id="share-expires" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue">
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Never expires</option>
                </select>
            </div>
            <button onclick="createShare()" class="w-full px-6 py-3 bg-archive-blue text-white rounded-lg font-semibold hover:bg-archive-purple transition-colors">
                Generate Share Link
            </button>
        </div>
    </div>

    <!-- Active Shares -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Active Shares</h2>
        
        {% if share_links %}
        <div class="space-y-4">
            {% for link in share_links %}
            <div class="border border-gray-200 rounded-lg p-4 hover:border-archive-blue transition-colors">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-semibold text-gray-900">{{ link.name }}</h3>
                        <p class="text-sm text-gray-600">Created: {{ link.created_date[:10] }}</p>
                        {% if link.expires_date %}
                        <p class="text-sm text-gray-600">Expires: {{ link.expires_date[:10] }}</p>
                        {% else %}
                        <p class="text-sm text-green-600 font-semibold">Never expires</p>
                        {% endif %}
                    </div>
                    <button onclick="revokeShare('{{ link.token }}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold">
                        Revoke
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="text" value="{{ request.host_url }}share/{{ link.token }}" readonly class="flex-1 px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm font-mono">
                    <button onclick="copyToClipboard('{{ request.host_url }}share/{{ link.token }}')" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-semibold">
                        Copy
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Views: {{ link.view_count }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500">No active shares yet. Create one above!</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function createShare() {
        const name = document.getElementById('share-name').value;
        const expires = parseInt(document.getElementById('share-expires').value);
        
        if (!name) {
            showToast('Please enter a share name', 'error');
            return;
        }

        fetch('/api/create_share', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, expires_days: expires || null })
        })
        .then(res => res.json())
        .then(data => {
            showToast('Share link created!');
            setTimeout(() => location.reload(), 1500);
        });
    }

    function revokeShare(token) {
        if (!confirm('Are you sure you want to revoke this share link?')) return;
        
        fetch(`/api/revoke_share/${token}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            showToast('Share link revoked');
            setTimeout(() => location.reload(), 1500);
        });
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Link copied to clipboard!');
        });
    }
</script>
{% endblock %}
