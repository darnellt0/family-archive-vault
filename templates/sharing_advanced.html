{% extends "base.html" %}

{% block title %}Sharing & Permissions - Family Archive Vault{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-archive-purple">Sharing & Permissions</h1>
    
    <!-- Create New Share Link Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Create a New Share Link</h2>
        
        <form id="createShareForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Link Name</label>
                    <input type="text" name="name" placeholder="e.g., Family Reunion 2024" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiration (Days)</label>
                    <input type="number" name="expires_days" value="7" min="1" max="365" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password (Optional)</label>
                    <input type="password" name="password" placeholder="Leave blank for no password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Views (Optional)</label>
                    <input type="number" name="max_views" placeholder="Leave blank for unlimited" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-archive-blue">
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <label class="flex items-center">
                    <input type="checkbox" name="allow_download" class="w-4 h-4 text-archive-blue rounded">
                    <span class="ml-2 text-sm text-gray-700">Allow Downloads</span>
                </label>
                
                <label class="flex items-center">
                    <input type="checkbox" name="access_type" value="edit" class="w-4 h-4 text-archive-blue rounded">
                    <span class="ml-2 text-sm text-gray-700">Allow Editing (Advanced)</span>
                </label>
            </div>
            
            <button type="submit" class="btn-primary">Create Share Link</button>
        </form>
    </div>
    
    <!-- Active Share Links Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-4">Active Share Links</h2>
        
        <div id="shareLinksContainer" class="space-y-4">
            <p class="text-gray-500">Loading share links...</p>
        </div>
    </div>
</div>

<script>
document.getElementById('createShareForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        expires_days: parseInt(formData.get('expires_days')),
        password: formData.get('password') || null,
        allow_download: formData.has('allow_download'),
        max_views: formData.get('max_views') ? parseInt(formData.get('max_views')) : null
    };
    
    try {
        const response = await fetch('/api/create-share-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (response.ok) {
            showNotification(`Share link created: ${result.token}`, 'success');
            e.target.reset();
            loadShareLinks();
        } else {
            showNotification(`Error: ${result.error}`, 'error');
        }
    } catch (error) {
        showNotification(`Error creating share link: ${error}`, 'error');
    }
});

async function loadShareLinks() {
    try {
        const response = await fetch('/api/share-links');
        const links = await response.json();
        
        const container = document.getElementById('shareLinksContainer');
        if (links.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No active share links yet.</p>';
            return;
        }
        
        container.innerHTML = links.map(link => `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="font-semibold text-lg">${link.name}</h3>
                        <p class="text-sm text-gray-600">Token: <code class="bg-gray-100 px-2 py-1 rounded">${link.token.substring(0, 16)}...</code></p>
                    </div>
                    <button onclick="copyToClipboard('${link.token}')" class="text-archive-blue hover:text-archive-purple text-sm font-medium">Copy Link</button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-600 mb-3">
                    <div>Views: <span class="font-semibold">${link.view_count}${link.max_views ? '/' + link.max_views : ''}</span></div>
                    <div>Expires: <span class="font-semibold">${new Date(link.expires_date).toLocaleDateString()}</span></div>
                    <div>Download: <span class="font-semibold">${link.allow_download ? 'Yes' : 'No'}</span></div>
                    <div>Password: <span class="font-semibold">${link.password_hash ? 'Yes' : 'No'}</span></div>
                </div>
                
                <button onclick="revokeShareLink('${link.token}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Revoke</button>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading share links:', error);
    }
}

function copyToClipboard(token) {
    const url = `${window.location.origin}/share/${token}`;
    navigator.clipboard.writeText(url).then(() => {
        showNotification('Share link copied to clipboard!', 'success');
    });
}

async function revokeShareLink(token) {
    if (!confirm('Are you sure you want to revoke this share link?')) return;
    
    try {
        const response = await fetch(`/api/revoke-share-link/${token}`, { method: 'POST' });
        if (response.ok) {
            showNotification('Share link revoked', 'success');
            loadShareLinks();
        }
    } catch (error) {
        showNotification(`Error revoking link: ${error}`, 'error');
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} shadow-lg`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Load share links on page load
loadShareLinks();
</script>
{% endblock %}
